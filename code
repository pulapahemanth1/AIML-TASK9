# ============================================
# Task 9: Random Forest – Credit Card Fraud Detection
# ============================================

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import joblib

from sklearn.model_selection import train_test_split
from sklearn.linear_model import LogisticRegression
from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import classification_report, confusion_matrix

# 1. Load Dataset
# NOTE: Download "creditcard.csv" from Kaggle Credit Card Fraud Dataset
df = pd.read_csv("creditcard.csv")

print("Dataset Shape:", df.shape)
print("\nClass Distribution:")
print(df['Class'].value_counts())

# 2. Separate features and target
X = df.drop(columns=['Class'])
y = df['Class']

# Remove non-useful identifier (Time can be optional; kept for learning)
# X = X.drop(columns=['Time'])

# 3. Train-test split with stratification
X_train, X_test, y_train, y_test = train_test_split(
    X, y,
    test_size=0.2,
    random_state=42,
    stratify=y
)

print("\nTrain class distribution:")
print(y_train.value_counts())

print("\nTest class distribution:")
print(y_test.value_counts())

# 4. Baseline Model – Logistic Regression
lr = LogisticRegression(max_iter=1000, class_weight='balanced')
lr.fit(X_train, y_train)

lr_preds = lr.predict(X_test)

print("\n=== Logistic Regression Performance ===")
print(confusion_matrix(y_test, lr_preds))
print(classification_report(y_test, lr_preds, digits=4))

# 5. Random Forest Model
rf = RandomForestClassifier(
    n_estimators=100,
    random_state=42,
    n_jobs=-1,
    class_weight='balanced'
)

rf.fit(X_train, y_train)

rf_preds = rf.predict(X_test)

print("\n=== Random Forest Performance ===")
print(confusion_matrix(y_test, rf_preds))
print(classification_report(y_test, rf_preds, digits=4))

# 6. Feature Importance Plot
importances = rf.feature_importances_
indices = np.argsort(importances)[::-1]

plt.figure(figsize=(12, 6))
plt.title("Feature Importance - Random Forest")
plt.bar(range(10), importances[indices[:10]])
plt.xticks(range(10), X.columns[indices[:10]], rotation=45)
plt.tight_layout()
plt.savefig("feature_importance.png")
plt.show()

# 7. Save Best Model
joblib.dump(rf, "random_forest_fraud_model.pkl")

print("\nModel saved as random_forest_fraud_model.pkl")
print("Feature importance plot saved as feature_importance.png")
